---
title: PocketerCRAé¡¹ç›®è¯´æ˜Ž
date: 2018-1-23 20:18:28
categories: æŠ€æœ¯å¤‡å¿˜
tags: [graphql]
---
# Pocketer-CRAé¡¹ç›®è¯´æ˜Ž
## ä¸»è¦æŠ€æœ¯ä»‹ç»
> ä½¿ç”¨graphqlå’Œmongodbå’Œ create-react-appæž„å»ºçš„é¡¹ç›®
> åˆ†ä¸ºä¸‰éƒ¨åˆ†:

> - `â‘ `.ç½‘ç«™å†…å®¹æŠ“å–å¹¶å­˜å…¥åˆ°mlabæ•°æ®åº“ 
> - `â‘¡`.æž„å»ºgraphql-serveræœåŠ¡å™¨æä¾›æŸ¥è¯¢æœåŠ¡ï¼ŒåŽå°é€šè¿‡mongooseå’Œmlabäº¤äº’ï¼ŒèŽ·å–æŸ¥è¯¢ä¿¡æ¯ã€‚
> - `â‘¢`.å‰ç«¯çš„CRAç¨‹åºï¼Œä½¿ç”¨react-apollo-hookså’ŒgraphqlæœåŠ¡å™¨äº¤äº’èŽ·å–æŸ¥è¯¢ä¿¡æ¯

##  ç½‘ç«™å†…å®¹æŠ“å–
### ç¨‹åºç»„æˆä¿¡æ¯
é€šè¿‡ [`http://gdom.graphene-python.org/graphql`](http://gdom.graphene-python.org/graphql) 
èŽ·å–Pocketerçš„å†…å®¹ä¿¡æ¯ã€‚ è¿™æ˜¯`request`æ¨¡å—éœ€è¦çš„`graphqlæœåŠ¡å™¨`åœ°å€urlåœ°å€.

Domç»“æž„å¦‚ä¸‹ï¼š

```
const getList = `query getList($url:String!){
    page(url: $url) {
        List: 
           query(selector: "#best_of_list ul li .item_content") {
           title: text(selector: ".title a")
           source: text(selector: "cite a")
           time: text(selector: "cite span")
           url: attr(selector: ".title a", name: "href")
           excerpt: text(selector: ".excerpt")
        }
    }
}`;
```

ä¼ å…¥è¦æŠ“å–ç½‘ç«™çš„é“¾æŽ¥ï¼Œå¡«å…¥è¦èŽ·å–ä¿¡æ¯çš„domç»“æž„ä¿¡æ¯ã€‚è¿™æ˜¯`request`æ¨¡å—éœ€è¦çš„çš„templateä¿¡æ¯.

### ä»£ç ç»“æž„
**request å‡½æ•°æŸ¯é‡ŒåŒ–**

```
//ä½¿ç”¨Ramda æŸ¯é‡ŒåŒ– requestå‡½æ•°çš„å‚æ•°
const handleGrqphcoolDataTemplate = R.curry(
    (api, template, variables) => (
        request(api, template, variables).then(data => {
          return data;
        })
    )
)

//æŸ¯ç†åŒ–çš„å‡½æ•°å…ˆä¼ é€’ graphqlæœåŠ¡å™¨çš„åœ°å€å’Œschema,ç­‰å¾… url å˜é‡

const queryData = handleGrqphcoolDataTemplate(gDomApi,getList);

```

**ä¼ å…¥urlåœ°å€åˆ°èŽ·å–æ•´ä¸ªæŠ“å–å¯¹è±¡çš„æ•°æ®æµï¼Œramdaçš„composeå‡½æ•°è´Ÿè´£ä»Žå³å‘å·¦ä¼ é€’æ•°æ®**

```
//1 æ‹¼æŽ¥é“¾æŽ¥å­—ç¬¦ä¸²
const  getUrlStringOfpocket=(str="javscript")=>`{"url":"https://getpocket.com/explore/${str}?src=search"}`; 
// 2 æ ¼å¼åŒ–æ¨¡æ¿jsonåŒ–
const JsonFormat = (UrlString) => JSON.parse(UrlString);

//3  æŸ¥è¯¢æ•°æ®
const queryPages = (queryStr) => queryData(queryStr) 
//4 æ•°æ®è„±æ‹¬å·çš„æ–¹æ³•,åŽ»æŽ‰å‰é¢çš„å‡ å±‚èŠ±æ‹¬å·çš„å±‚çº§ 
const getArray =async (obj) => obj.page.List;
//ç„¶åŽä¼ å…¥ç­‰å¾…é“¾æŽ¥çš„graphqlæŸ¥è¯¢å‡½æ•°,ä½¿ç”¨å¼‚æ­¥compose,ä»Žå³å‘å·¦æ‰§è¡Œæµç¨‹
const getPagesArray = asyncompose(getArray,queryPages,JsonFormat,getUrlStringOfpocket); 
```



**â€Œå€ŸåŠ©Mongooseæ’å…¥æ•°æ®åˆ°mlab æ•°æ®åº“**
`config.js`

```javascript
const mongoose = require('mongoose');
mongoose.Promise = global.Promise;

const   MONGO_URL='mongodb://user:user1234@ds048368.mlab.com:48368/pocket-excerpt';

mongoose.connect(MONGO_URL, { useNewUrlParser: true });
mongoose.connection.once('open', () => console.log(`Connected to mongo at ${MONGO_URL}`));
```
åœ¨`config.js`æ–‡ä»¶ä¸­é…ç½®mlabæ•°æ®åº“å’Œmongooseé…ç½®,mongooseéœ€è¦è®¾ç½®schemaï¼Œmongooseçš„schemaå’ŒGraphqlçš„schemaå¾ˆç›¸ä¼¼ï¼Œæ‰€ä»¥ä¸€èµ·ä½¿ç”¨å¾ˆæ–¹ä¾¿

```javascript
const mongoose = require('mongoose');
const { Schema } = mongoose;

const News = new Schema({
  cate:String,
  title: String,
  source: String,
  time: String,
  url:String,
  excerpt:String,
});

const newsModel = mongoose.model('News', News); 

module.exports = {
  newsModel
};
```

åˆ›å»ºçš„é¢newModelæ¨¡åž‹æ€§å¯¹è±¡å°±æŒ‚åœ¨äº†æ ¹æ®schemaæ“ä½œmongodbçš„æ–¹æ³•ã€‚ç›´æŽ¥æ‰§è¡ŒåŠã“äº†

**æ’å…¥æ“ä½œ**

```javascript
const dbForData= async (args)=>{
           newsModel.create(args); //æ’å…¥æ•°æ®
           log(chalk.green('insert %s'),args.title);
    };
```

åªåªè¦æä¾›çš„å‚æ•°å’Œschemaçš„ä¸€æ ·ï¼Œæ’å…¥å°±å¾ˆç®€å•ï¼Œåªè¦ä¸€ä¸ª`model.create(args)`å°±å¯ä»¥äº†ã€‚

æ¨¡åž‹ä¸­å®šä¹‰äº†cateï¼Œç”¨äºŽpocketerçš„åˆ†ç±»ï¼Œ æ‰€ä»¥åœ¨ä»Žç½‘ç«™æŠ“å–çš„ä¿¡æ¯ä¸­æ·»åŠ è¿™ä¸ªcateå­—æ®µ

```
//èŽ·å–çš„æ•°æ®
const Array= await getPagesArray(str);
           //const db= await dbForData(_) ;
           
           //éåŽ†å¯¹è±¡æ·»åŠ æŸ¥è¯¢å­—ç¬¦ä¸²ä½œä¸ºåˆ†ç±»æ ‡è®°
           const addCate=  (obj)=>{
                return Object.assign({}, obj, {
                    cate: cate,
                })
            }
//éåŽ†èŽ·å–çš„æ•°ç»„æ¯ç¯‡æ–‡ç« çš„ä¿¡æ¯ï¼Œæ·»åŠ cateå­—æ®µ
const ArrayaddCate=  Array.map(addCate);
```


**éåŽ†æ•°ç»„ï¼Œæ‰§è¡Œæ’å…¥æ“ä½œ**

```
await  R.map(dbForData,ArrayaddCate);
```

ä»¥ä¸Šä»£ç æ˜¯å•ä¸ªæœç´¢å­—ç¬¦ä¸²çš„æ’å…¥ç»“æžœï¼Œæ¯ä¸ªå­—ç¬¦ä¸²ä¸‹é¢å¯ä»¥æŸ¥åˆ°å¾ˆå¤šæ–‡ç« ã€‚ ç›¸å½“äºŽå•ä¸ªå”®ç¥¨çª—å£çš„é˜Ÿåˆ—ã€‚ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¼ å…¥å¤šä¸ªå­—ç¬¦ä¸²ï¼Œè¿™å°±ç›¸å½“äºŽå”®ç¥¨å¤„å¼€äº†å¤šä¸ªçª—å£ã€‚å¤šä¸ªçª—å£ä¹‹é—´çš„æ“ä½œæ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚ åœ¨å•ä¸ªçª—å£çš„æ“ä½œå…¶å®žä¹Ÿå¯ä»¥æ˜¯å¹¶è¡Œæ“ä½œã€‚è¿™é‡Œæ²¡æœ‰è€ƒè™‘ã€‚

æ‰§è¡Œå¤šä¸ªå­—ç¬¦ä¸²çš„æ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š


```
const  insertData= async (items)=> {
     //itemsæ˜¯ä¼ å…¥çš„å¤šä¸ªå­—ç¬¦ä¸²   
        const promises = items.map((item) => getData(item));
        await Promise.all(promises);
        log(chalk.yellow('Total Done !'));     
    }

    await  insertData(searchkeywords);
```

ä¸Šé¢ä»£ç ä¸­itemså°±æ˜¯ä¼ å…¥çš„å¤šä¸ªæŸ¥è¯¢å­—ç¬¦ä¸²ç»„æˆçš„æ•°ç»„ï¼Œ éåŽ†å®ƒï¼Œå› ä¸ºæ•°ç»„ä¸­æ¯ä¸ªå­—ç¬¦ä¸²å…ƒç´ è¿”å›žçš„éƒ½æ˜¯promiseå¯¹è±¡ï¼Œ ä½¿ç”¨mapæ–¹æ³•ç»„æˆpromiseæ•°ç»„ï¼Œ
ç„¶åŽä½¿ç”¨Promise.allæ–¹æ³•å¹¶è¡Œæ‰§è¡Œæ“ä½œã€‚

**â€Œå•ä¸ªå­—ç¬¦ä¸²çš„æµç¨‹è¿˜è¦ä¿®æ”¹ä¸€ä¸‹ï¼Œæ¯ç¯‡æ–‡ç« çš„æ“ä½œä»ç„¶æ˜¯å¹¶å‘çš„**


## æœ¬åœ°çš„graphql-serverçš„æž„å»º
ä½¿ç”¨äº†apollo-graphql-expressæž„å»º

æä¾› `typeDefs`å’Œ`resolvers`å°±å¯ä»¥äº†ã€‚ æœåŠ¡å™¨æŽ¥å—æ‰§è¡ŒæŒ‡ä»¤ï¼Œ ç„¶åŽåœ¨resolversä¸­æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œç„¶åŽè¿”å›žGraphqlç»“æžœ

**graphqlå‚æ•°å®šä¹‰**


```
const typeDefs = gql`
    type News {
        id: ID!
        cate:String,
        title: String,
        source: String,
        time: String, 
        url:  String ,
        excerpt: String,
    }

    type Query {
        getAllNews: [News]
    }
    type Mutation {
        addOneNews(
            cate:String,
            title: String, 
            source: String,
            time:String,
            url: String,
            excerpt: String,
        ): News
    }
`;
const resolvers = {
    Query: {
        getAllNews: async () => await newsModel.find({}).exec()
    },
    Mutation: {
        addOneNews: async (_, args) => {
            try {
                console.log(args);
                let response = await newsModel.create(args);
                return response;
            } catch(e) {
                return e.message;
            }
        }
    }
};
```

**graphQLæœåŠ¡å™¨åˆå§‹åŒ–**

```
const server = new ApolloServer({ typeDefs, resolvers });
const app = express();
server.applyMiddleware({ app });

app.listen({ port: 4000 }, () =>
  console.log(`ðŸš€ Server ready at http://localhost:4000${server.graphqlPath}`)
);
```


## Create-React-App æž„å»º
æ·»åŠ äº†styled-components,reactstrap,react-apollo-hooksã€‚

