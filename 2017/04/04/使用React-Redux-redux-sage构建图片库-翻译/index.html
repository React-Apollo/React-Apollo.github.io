<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">




  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Redux,saga,">










<meta name="description" content="看到这篇文章build an image gallery using redux saga，觉得写的不错，长短也适中.  文后有注释版的github代码库,请使用comment分枝. Flickr API可能需要有fQ的基本能力.可以使用google的翻译作为参考，这篇文章google翻译版的中文水平让我吃了一惊.翻译已经完成.   使用React,Redux和reudx-saga构建一个图像浏">
<meta name="keywords" content="Redux,saga">
<meta property="og:type" content="article">
<meta property="og:title" content="使用React,Redux,redux-sage构建图片库(翻译)">
<meta property="og:url" content="https://React-Apollo.github.io/2017/04/04/使用React-Redux-redux-sage构建图片库-翻译/index.html">
<meta property="og:site_name" content="Javascript-React-Apollo-GraphQL-Ramda-Prisma">
<meta property="og:description" content="看到这篇文章build an image gallery using redux saga，觉得写的不错，长短也适中.  文后有注释版的github代码库,请使用comment分枝. Flickr API可能需要有fQ的基本能力.可以使用google的翻译作为参考，这篇文章google翻译版的中文水平让我吃了一惊.翻译已经完成.   使用React,Redux和reudx-saga构建一个图像浏">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2044710-b0d03ac095f09c55.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2044710-b24265cbe5f89d88.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2044710-6667a047b669d287.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/320">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2044710-72a9136f9b481bf6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620">
<meta property="og:image" content="https://react-apollo.github.io/2017/04/04/使用React-Redux-redux-sage构建图片库-翻译/%7Bimage%7D/">
<meta property="og:image" content="https://react-apollo.github.io/2017/04/04/使用React-Redux-redux-sage构建图片库-翻译/%7Bimage%7D/">
<meta property="og:updated_time" content="2019-04-28T05:52:57.896Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用React,Redux,redux-sage构建图片库(翻译)">
<meta name="twitter:description" content="看到这篇文章build an image gallery using redux saga，觉得写的不错，长短也适中.  文后有注释版的github代码库,请使用comment分枝. Flickr API可能需要有fQ的基本能力.可以使用google的翻译作为参考，这篇文章google翻译版的中文水平让我吃了一惊.翻译已经完成.   使用React,Redux和reudx-saga构建一个图像浏">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/2044710-b0d03ac095f09c55.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://React-Apollo.github.io/2017/04/04/使用React-Redux-redux-sage构建图片库-翻译/">





  <title>使用React,Redux,redux-sage构建图片库(翻译) | Javascript-React-Apollo-GraphQL-Ramda-Prisma</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Javascript-React-Apollo-GraphQL-Ramda-Prisma</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">All In One</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://React-Apollo.github.io/2017/04/04/使用React-Redux-redux-sage构建图片库-翻译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="React-Apollo">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Javascript-React-Apollo-GraphQL-Ramda-Prisma">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">使用React,Redux,redux-sage构建图片库(翻译)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-04T13:18:28+00:00">
                2017-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-04-28T05:52:57+00:00">
                2019-04-28
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/翻译/" itemprop="url" rel="index">
                    <span itemprop="name">翻译</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/04/04/使用React-Redux-redux-sage构建图片库-翻译/" class="leancloud_visitors" data-flag-title="使用React,Redux,redux-sage构建图片库(翻译)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  10,334
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  45
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <blockquote>
<p>看到这篇文章<a href="http://joelhooks.com/blog/2016/03/20/build-an-image-gallery-using-redux-saga/" target="_blank" rel="noopener">build an image gallery using redux saga</a>，觉得写的不错，长短也适中.  文后有<a href="https://github.com/phpsmarter/egghead-react-redux-image-gallery/tree/comment" target="_blank" rel="noopener">注释版的github代码库,请使用comment分枝</a>. Flickr API可能需要有fQ的基本能力.可以使用google的翻译作为参考，这篇文章google翻译版的中文水平让我吃了一惊.<br>翻译已经完成.</p>
</blockquote>
<hr>
<h3 id="使用React-Redux和reudx-saga构建一个图像浏览程序-翻译"><a href="#使用React-Redux和reudx-saga构建一个图像浏览程序-翻译" class="headerlink" title="使用React,Redux和reudx-saga构建一个图像浏览程序(翻译)"></a>使用React,Redux和reudx-saga构建一个图像浏览程序(翻译)</h3><p>Joel Hooks ,2016年3月</p>
<h5 id="构建一个图片长廊"><a href="#构建一个图片长廊" class="headerlink" title="构建一个图片长廊"></a>构建一个图片长廊</h5><p>图像长廊是一个简单的程序，从Flicker API 加载图片URLs,允许用户查看图片详情。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2044710-b0d03ac095f09c55.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/240" alt="Screen Shot 2016-03-20 at 3.42.17 PM-2.png"></p>
<p>后续我们会使用React,Redux和redux-saga.React作为核心框架，优势是虚拟dom(virtual-dom)的实现。Redux在程序内负责state的管理。最后，我们会使用redux-saga来执行javascript的异步操作步骤。</p>
<p>我们会使用ES6(箭头函数，模块，和模板字符串)，所以我们首先需要做一些项目的配置工作。</p>
<p>#####项目配置和自动化</p>
<hr>
<p>如果要开始一个React项目，须有有一系列的配置选项。对于一个简单的项目，我想把配置选项尽可能缩减。考虑到浏览器的版本问题，使用Babel把ES6编译为ES5。</p>
<p>首先使用npm init 创建一个<code>package.json</code>文件</p>
<p>package.json</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JAVASCRIPT"><figure class="iseeu highlight /javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">  &#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"egghead-react-redux-image-gallery"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"0.0.1"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">"Redux Saga beginner tutorial"</span>,</span><br><span class="line">  <span class="string">"main"</span>: <span class="string">"src/main.js"</span>,</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"test"</span>: <span class="string">"babel-node ./src/saga.spec.js | tap-spec"</span>,</span><br><span class="line">    <span class="string">"start"</span>: <span class="string">"budo ./src/main.js:build.js --dir ./src --verbose  --live -- -t babelify"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"repository"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"git"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"git+https://github.com/joelhooks/egghead-react-redux-image-gallery.git"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"author"</span>: <span class="string">"Joel Hooks &lt;joelhooks@gmail.com&gt;"</span>,</span><br><span class="line">  <span class="string">"license"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">  <span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"babel-polyfill"</span>: <span class="string">"6.3.14"</span>,</span><br><span class="line">    <span class="string">"react"</span>: <span class="string">"^0.14.3"</span>,</span><br><span class="line">    <span class="string">"react-dom"</span>: <span class="string">"^0.14.3"</span>,</span><br><span class="line">    <span class="string">"react-redux"</span>: <span class="string">"^4.4.1"</span>,</span><br><span class="line">    <span class="string">"redux"</span>: <span class="string">"^3.3.1"</span>,</span><br><span class="line">    <span class="string">"redux-saga"</span>: <span class="string">"^0.8.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"babel-cli"</span>: <span class="string">"^6.1.18"</span>,</span><br><span class="line">    <span class="string">"babel-core"</span>: <span class="string">"6.4.0"</span>,</span><br><span class="line">    <span class="string">"babel-preset-es2015"</span>: <span class="string">"^6.1.18"</span>,</span><br><span class="line">    <span class="string">"babel-preset-react"</span>: <span class="string">"^6.1.18"</span>,</span><br><span class="line">    <span class="string">"babel-preset-stage-2"</span>: <span class="string">"^6.1.18"</span>,</span><br><span class="line">    <span class="string">"babelify"</span>: <span class="string">"^7.2.0"</span>,</span><br><span class="line">    <span class="string">"browserify"</span>: <span class="string">"^13.0.0"</span>,</span><br><span class="line">    <span class="string">"budo"</span>: <span class="string">"^8.0.4"</span>,</span><br><span class="line">    <span class="string">"tap-spec"</span>: <span class="string">"^4.1.1"</span>,</span><br><span class="line">    <span class="string">"tape"</span>: <span class="string">"^4.2.2"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<hr>
<p> 有了<code>package.json</code>, 可以在项目文件夹命令行运行 <code>npm install</code> 安装程序需要的依赖项。</p>
<p> .babelrc</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JSON"><figure class="iseeu highlight /json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [<span class="string">"es2015"</span>, <span class="string">"react"</span>, <span class="string">"stage-2"</span>]</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></div>
<p>这个文件告诉babel,我们将会使用ES2015(ES6),React以及ES2106的stage-2的一些特征。</p>
<p><code>package.json</code>有两个标准的script脚本配置：<code>start</code>和<code>test</code>.现在我们想通过start脚本加载程序，start会使用<code>src</code>目录的一些文件，所以西药先创建<code>src</code>文件夹.在<code>src</code>文件夹添加下面的一些文：</p>
<p><code>index.html</code></p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="XML"><figure class="iseeu highlight /xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>egghead: React Redux Image Gallery<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"styles.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">  ![](http://cloud.egghead.io/2G021h3t2K10/download/egghead-logo-head-only.svg)</span><br><span class="line">  <span class="tag">&lt;<span class="name">h3</span>&gt;</span>Egghead Image Gallery<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"build.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p><code>main.js</code></p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JAVASCRIPT"><figure class="iseeu highlight /javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"babel-polyfill"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;h1&gt;Hello React!<span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></div>
<p><code>style.css</code></p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="CSS"><figure class="iseeu highlight /css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">    <span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: Helvetica, Arial, Sans-Serif, sans-serif;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.title</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">2px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.egghead</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.image-gallery</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid darkgray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.gallery-image</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">250px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.gallery-image</span> <span class="selector-tag">img</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">max-height</span>: <span class="number">250px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.image-scroller</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-around;</span><br><span class="line">    <span class="attribute">overflow</span>: auto;</span><br><span class="line">    <span class="attribute">overflow-y</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.image-scroller</span> <span class="selector-tag">img</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">1px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>index.html</code>文件加载<code>style.css</code>文件提供一些基本的布局样式，同时也加载<code>build.js</code>文件，这是一个生成出来的文件.<code>main.js</code>是一个最基础的React程序，他在<code>index.html</code>的<code>#root</code>元素中渲染一个<code>h1</code>元素。创建这些文件以后，在项目文件夹中命令行运行<code>npm start</code>。在浏览器打开<code>http://10.11.12.1:9966</code>.就可以看到<code>index.html</code>中渲染的页面</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2044710-b24265cbe5f89d88.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/240" alt="运行加载图"></p>
<p>现在我们来构建基础的<code>Gallery</code> React 组件</p>
<h5 id="在Gallery中显示一些图片"><a href="#在Gallery中显示一些图片" class="headerlink" title="在Gallery中显示一些图片"></a>在Gallery中显示一些图片</h5><p> 首先我们需要尽可能快的获得一个可以显示的图片素材.在项目文件夹中创建一个文件<code>Gallery.js</code></p>
<p> <code>Gallery.js</code></p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AXAPTA"><figure class="iseeu highlight /axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    import React, &#123;Component&#125; from <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line">const flickrImages = [</span><br><span class="line">  <span class="string">"https://farm2.staticflickr.com/1553/25266806624_fdd55cecbc.jpg"</span>,</span><br><span class="line">  <span class="string">"https://farm2.staticflickr.com/1581/25283151224_50f8da511e.jpg"</span>,</span><br><span class="line">  <span class="string">"https://farm2.staticflickr.com/1653/25265109363_f204ea7b54.jpg"</span>,</span><br><span class="line">  <span class="string">"https://farm2.staticflickr.com/1571/25911417225_a74c8041b0.jpg"</span>,</span><br><span class="line">  <span class="string">"https://farm2.staticflickr.com/1450/25888412766_44745cbca3.jpg"</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Gallery</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      images: flickrImages,</span><br><span class="line">      selectedImage: flickrImages[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123;images, selectedImage&#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;<span class="keyword">div</span> className=<span class="string">"image-gallery"</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">div</span> className=<span class="string">"gallery-image"</span>&gt;</span><br><span class="line">          &lt;<span class="keyword">div</span>&gt;</span><br><span class="line">            &lt;img src=&#123;selectedImage&#125; /&gt;</span><br><span class="line">          &lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">        &lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">div</span> className=<span class="string">"image-scroller"</span>&gt;</span><br><span class="line">          &#123;images.map((image, <span class="keyword">index</span>) =&gt; (</span><br><span class="line">            &lt;<span class="keyword">div</span> key=&#123;<span class="keyword">index</span>&#125;&gt;</span><br><span class="line">              &lt;img src=&#123;image&#125;/&gt;</span><br><span class="line">            &lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">          ))&#125;</span><br><span class="line">        &lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">      &lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>  我们直接在组件中硬编码了一个提供数据的数组，让项目尽快的工作起来.<code>Gallery组件</code>继承<code>Component组件</code>,在构造函数中创建一些组件的出事状态.最后我们利用一些样式标记渲染一下文件。<code>image-scroller</code>元素遍历(<code>map</code>方法)图片数组,生成摘要小图片。</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JAVASCRIPT"><figure class="iseeu highlight /javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">import</span> <span class="string">"babel-polyfill"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"></span><br><span class="line">+ <span class="keyword">import</span> Gallery <span class="keyword">from</span> <span class="string">'./Gallery'</span></span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">-  <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello React!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>,</span><br><span class="line">+  <span class="xml"><span class="tag">&lt;<span class="name">Gallery</span> /&gt;</span>,</span></span><br><span class="line"><span class="xml">  document.getElementById('root')</span></span><br><span class="line"><span class="xml">);</span></span><br></pre></td></tr></table></figure></div>
<p>  到现在，我们使用硬编码的图片URLs(通过fickrImages)数组,第一张图片作为<code>selectedImage</code>.这些属性在<code>Gallery</code>组件的构造函数缺省配置中，通过初始状态(initial)来设定.</p>
<p>  接下来在组件中添加一个和组件进行交互操作的方法，方法具体内容是操做<code>setSate</code>.<br>  Gallery.js</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AXAPTA"><figure class="iseeu highlight /axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">export <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Gallery</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      images: flickrImages,</span><br><span class="line">      selectedImage: flickrImages[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">+  handleThumbClick(selectedImage) &#123;</span><br><span class="line">+    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">+      selectedImage</span><br><span class="line">+   &#125;)</span><br><span class="line">+  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123;images, selectedImage&#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;<span class="keyword">div</span> className=<span class="string">"image-gallery"</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">div</span> className=<span class="string">"gallery-image"</span>&gt;</span><br><span class="line">          &lt;<span class="keyword">div</span>&gt;</span><br><span class="line">            &lt;img src=&#123;selectedImage&#125; /&gt;</span><br><span class="line">          &lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">        &lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">div</span> className=<span class="string">"image-scroller"</span>&gt;</span><br><span class="line">          &#123;images.map((image, <span class="keyword">index</span>) =&gt; (</span><br><span class="line">-            &lt;<span class="keyword">div</span> key=&#123;<span class="keyword">index</span>&#125;&gt;</span><br><span class="line">+            &lt;<span class="keyword">div</span> key=&#123;<span class="keyword">index</span>&#125; onClick=&#123;<span class="keyword">this</span>.handleThumbClick.bind(<span class="keyword">this</span>,image)&#125;&gt;</span><br><span class="line">              &lt;img src=&#123;image&#125;/&gt;</span><br><span class="line">            &lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">          ))&#125;</span><br><span class="line">        &lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">      &lt;/<span class="keyword">div</span>&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>在<code>Gallery组件</code>添加<code>handleThumbClick</code>方法,任何元素都可用通过<code>onClick</code>属性调用这个方法.<code>image</code>作为第二个参数传递，元素自身作为第一个参数传递.bind方法传递javascript函数调用上下文对象是非常便捷。</p>
<p>看起来不错!现在我们有了一些交互操作的方法，有点“APP”的意思了。截止目前，我们已经让app运行起来了，接下来要考虑怎么加载远程数据。最容易加载远程数据的地方是一个<code>React组件</code>生命周期方法,我们使用<code>componentDidMount</code>方法,通过他从<code>Flikr API</code>请求并加载一些图片.</p>
<p><code>Gallery.js</code></p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JAVASCRIPT"><figure class="iseeu highlight /javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Gallery</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      images: flickrImages,</span><br><span class="line">      selectedImage: flickrImages[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">+  componentDidMount() &#123;</span><br><span class="line">+    <span class="keyword">const</span> API_KEY = <span class="string">'a46a979f39c49975dbdd23b378e6d3d5'</span>;</span><br><span class="line">+    <span class="keyword">const</span> API_ENDPOINT = <span class="string">`https://api.flickr.com/services/rest/?method=flickr.interestingness.+getList&amp;api_key=<span class="subst">$&#123;API_KEY&#125;</span>&amp;format=json&amp;nojsoncallback=1&amp;per_page=5`</span>;+</span><br><span class="line">+</span><br><span class="line">+    fetch(API_ENDPOINT).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">+      <span class="keyword">return</span> response.json().then(<span class="function">(<span class="params">json</span>) =&gt;</span> &#123;</span><br><span class="line">+        <span class="keyword">const</span> images = json.photos.photo.map(<span class="function">(<span class="params">&#123;farm, server, id, secret&#125;</span>) =&gt;</span> &#123; </span><br><span class="line">+            <span class="keyword">return</span> <span class="string">`https://farm<span class="subst">$&#123;farm&#125;</span>.staticflickr.com/<span class="subst">$&#123;server&#125;</span>/<span class="subst">$&#123;id&#125;</span>_<span class="subst">$&#123;secret&#125;</span>.jpg`</span></span><br><span class="line">+        &#125;);</span><br><span class="line">+</span><br><span class="line">+        <span class="keyword">this</span>.setState(&#123;images, <span class="attr">selectedImage</span>: images[<span class="number">0</span>]&#125;);</span><br><span class="line">+      &#125;)</span><br><span class="line">+    &#125;)</span><br><span class="line">+  &#125;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure></div>
<p>我们在<code>Gallery</code>类中添加了一个新的方法,通过React的<code>componentDidMount</code>生命周期方法触发Flickr图片数据的获取。</p>
<p>在<code>React</code>组件运行的不同时间点，组件会调用不同的生命周期函数。在这段代码中，当组件被渲染到<code>DOM</code>中的时间点,<code>componentDidMount</code>函数就会被调用。需要注意的是:<code>Gallery</code>组件只有一次渲染到<code>DOM</code>的机会，所以这个函数可以提供一些初始化图片.考虑到在APP的整个生命周期中,有更多的动态组件的加载和卸载,这可能会造成一些多余的调用和无法考虑到的结果。</p>
<p>我们使用浏览器接口(browser API)的<code>fetch</code>方法执行请求.Fetch返回一个promise对象解析<code>response</code>对象.调用<code>response.json()</code>方法,返回另一个promise对象，这就是我们实际需要的<code>json</code>格式的数据.遍历这个对象以后就可以获取图片的url地址.</p>
<blockquote>
<p>坦白讲，这个应用目前还很简单.我们还需要在这里花费更多的时间，还有一些基础的需求需要完成.或许我们应该在promise处理流程中添加错误处理方法,如果图片数据获取成功也需要一些处理逻辑.在这个地方，你需要发挥一些想象力考虑一下更多的逻辑.在生产实践中简单的需求是很少见的.很快,应用中就会添加更多的需求。认证,滚动橱窗,加载不同图片库的能力和图片的设置等等.仅仅这些还远远不够.</p>
</blockquote>
<p>我们已经使用<code>React</code>构建了一个加载图片库的程序。接下来我们需要考虑到随着程序功能的添加，到底需要哪些基础的模式.首先考虑到的一个问题就是要把应用的状态(state)控制从<code>Gallery</code>组件中分离出来.</p>
<p>我们通过引入<code>Redux</code>来完成应用的状态管理工作。</p>
<h5 id="使用Redux来管理状态"><a href="#使用Redux来管理状态" class="headerlink" title="使用Redux来管理状态"></a>使用<code>Redux</code>来管理状态</h5><p>在你的应用中只要使用了<code>setState</code>方法都会让一个组件从无状态变为有状态的组件.糟糕的是这个方法会导致应用中出现一些令人困惑的代码,这些代码会在应用中到处蔓延。</p>
<p><code>Flux</code>构架来减轻这个问题.<code>Flux</code>把逻辑(logic)和状态(state)迁移到<code>Store</code>中.应用中的动作(<code>Actions</code>)被<code>Dispatch</code>的时候,<code>Stores</code><br>会做相应的更新.<code>Stores</code>的更新会触发<code>View</code>根据新状态的渲染.</p>
<p>那么我们为什么要舍弃<code>Flux</code>?他竟然还是“官方”构建的.<br>好吧！<code>Redux</code>是基于<code>Flux</code>构架的,但是他有一些独特的优势.下面是Dan Abramov(Redux创建者)的一些话：</p>
<blockquote>
<p>Redux和Flux没有什么不同.总体来讲他们是相同的构架,但是Redux通过功能组合把Flux使用回调注册的复杂点给屏蔽掉了.<br>两个构架从更本上讲没有什么不同，但是我发现Redux使一些在Flux比较难实现的逻辑更容易实现.</p>
</blockquote>
<p><a href="http://cn.redux.js.org/index.html" target="_blank" rel="noopener">Redux文档</a>非常棒.<br>如果你还没有读过代码的卡通教程或者Dan的系列文章.赶快去看看吧！</p>
<h5 id="启动Redux"><a href="#启动Redux" class="headerlink" title="启动Redux"></a>启动Redux</h5><p>第一件需要做的事事初始化<code>Redux</code>,让他在我们的程序中运行起来.现在不需要做安装工作，刚开始运行<code>npm install</code>的时候已经安装好了依赖项，我们需要做一些导入和配置工作.<br><strong>reducer函数是Redux的大脑.</strong> 每当应用分发(或派遣,dispatch)一个操作(action)的时候,<code>reducer</code>函数会接受操作(action)并且依据这个动作(action)创建<code>reducer</code>自己的<code>state</code>.因为<code>reducers</code>是纯函数，他们可以组合到一起，创建应用的<code>一个完整state</code>.让我们在<code>src</code>中创建一个简单的reducer:</p>
<p><code>reducer.js</code></p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PF"><figure class="iseeu highlight /pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export <span class="keyword">default</span> function images(<span class="keyword">state</span>, action) &#123;</span><br><span class="line">   console.<span class="keyword">log</span>(<span class="keyword">state</span>, action)</span><br><span class="line">   return <span class="keyword">state</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p> 一个reducer函数接受两个参数(arguments).</p>
<ol>
<li>[x] <code>state</code>-这个数据代表应用的状态(state).reducer函数使用这个状态来构建一个reducer自己可以管理的状态.如果状态没有发生改变,reducer会返回输入的状态.</li>
<li>[x]  <code>action</code>-这是触发reducer的事件.Actions通过store派发(dispatch),由reducer处理.action需要一个<code>type</code>属性来告诉reducer怎么处理state.</li>
</ol>
<p>目前,<code>images</code> reuducer在终端中打印出日志记录，表明工作流程是正常的，可以做接下来的工作了.为了使用reducer，需要在<code>main.js</code>中做一些配置工作:</p>
<p><code>main.js</code></p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JAVASCRIPT"><figure class="iseeu highlight /javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"babel-polyfill"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Gallery <span class="keyword">from</span> <span class="string">'./Gallery'</span>;</span><br><span class="line"></span><br><span class="line">+ <span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line">+ <span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'./reducer'</span></span><br><span class="line"></span><br><span class="line">+ <span class="keyword">const</span> store = createStore(reducer);</span><br><span class="line"></span><br><span class="line">+ <span class="keyword">import</span> &#123;Provider&#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">+  <span class="xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;store&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Gallery</span> /&gt;</span></span></span><br><span class="line"><span class="xml">+  <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span>,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line">);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p> 我们从<code>Redux</code>库中导入<code>createStore</code>组件.<code>creatStore</code>用来创建Redux的store.大多数情况下,我们不会和store直接交互,store在Redux中做幕后管理工作.</p>
<p> 也需要导入刚才创建的reducer函数,以便于他可以被发送到store.<br> 我们将通过<code>createStore(reducer)</code>操作，利用reducer来配置应用的store.这个示例仅仅只有一个reducer,但是<code>createStore</code>可以接收多个reducer作为参数.稍后我们会看到这一点.</p>
<p> 最后我们导入高度集成化的组件<code>Provider</code>,这个组件用来包装<code>Gallery</code>,以便于我们在应用中使用Redux.我们需要把刚刚创建的store传递给<code>Provider</code>.你也可以不使用<code>Provider</code>,实际上Redux可以不需要React.但是我们将会使用<code>Provider</code>,因为他非常便于使用.</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2044710-6667a047b669d287.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/320" alt="打印日志"></p>
<p> 这张图可能有点古怪，但是展示了Redux的一个有意思的地方.所有的reducers接收在应用中的全部actions(动作或操作).在这个例子中我们可以看到Redux自己派发的一个<code>action</code>.</p>
<h5 id="连接Gallery组件"><a href="#连接Gallery组件" class="headerlink" title="连接Gallery组件"></a>连接Gallery组件</h5><p> 借助Redux,我们将使用”connected”和“un-connected”组件.一个<code>connected</code>组件被连线到store.<code>connected</code>组件使控制动作事件(controls action event)和store协作起来.通常,一个<code>connected</code>组件有子组件,子组件具有单纯的接收输入和渲染功能，当数据更新时执行调用.这个子组件就是unconnected组件.</p>
<blockquote>
<p>提示:当Rect和Redux配合是工作的非常好,但是Redux不是非要和React在一起才能工作.没有React,Redux其实可以和其他框架配合使用.</p>
</blockquote>
<p>在应用中需要关联<code>React组件</code>和<code>Redux Store</code> 的时候，<code>react-redux</code>提供了便捷的包装器.我们把react-redux添加进<code>Gallery</code>中<br>,从而使<code>Gallery</code>成为首要的关联组件.</p>
<p><code>Gallery.js</code><br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="COFFEESCRIPT"><figure class="iseeu highlight /coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line">+<span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"></span><br><span class="line">-<span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Gallery</span> <span class="keyword">extends</span> <span class="title">Component</span> &#123;</span></span><br><span class="line">+<span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Gallery</span> <span class="keyword">extends</span> <span class="title">Component</span> &#123;</span></span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">+    <span class="built_in">console</span>.log(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      images: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    const API_KEY = <span class="string">'a46a979f39c49975dbdd23b378e6d3d5'</span>;</span><br><span class="line">    const API_ENDPOINT = `<span class="javascript">https:<span class="comment">//api.flickr.com/services/rest/?method=flickr.interestingness.getList&amp;api_key=$&#123;API_KEY&#125;&amp;format=json&amp;nojsoncallback=1&amp;per_page=5</span></span>`;</span><br><span class="line"></span><br><span class="line">    fetch(API_ENDPOINT).<span class="keyword">then</span>(<span class="function"><span class="params">(response)</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> response.json().<span class="keyword">then</span>(<span class="function"><span class="params">(json)</span> =&gt;</span> &#123;</span><br><span class="line">        const images = json.photos.photo.map(<span class="function"><span class="params">(&#123;farm, server, id, secret&#125;)</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> `<span class="javascript">https:<span class="comment">//farm$&#123;farm&#125;.staticflickr.com/$&#123;server&#125;/$&#123;id&#125;_$&#123;secret&#125;.jpg</span></span>`</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;images, selectedImage: images[<span class="number">0</span>]&#125;);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  handleThumbClick(selectedImage) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      selectedImage</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123;images, selectedImage&#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">"image-gallery"</span>&gt;</span><br><span class="line">        &lt;div className=<span class="string">"gallery-image"</span>&gt;</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;img src=&#123;selectedImage&#125; /&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div className=<span class="string">"image-scroller"</span>&gt;</span><br><span class="line">          &#123;images.map(<span class="function"><span class="params">(image, index)</span> =&gt;</span> (</span><br><span class="line">            &lt;div key=&#123;index&#125; onClick=&#123;<span class="keyword">this</span>.handleThumbClick.bind(<span class="keyword">this</span>,image)&#125;&gt;</span><br><span class="line">              &lt;img src=&#123;image&#125;/&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          ))&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+<span class="keyword">export</span> <span class="keyword">default</span> connect()(Gallery)</span><br></pre></td></tr></table></figure></div></p>
<p>从<code>react-redux</code>导入<code>connect</code>函数,可以在导出组件的时候把他变为链接组件(connected component).请注意,<code>connect()(Gallery)</code>代码把<code>Gallery</code>组件放在第二个形参中,这是因为<code>connect()</code>返回一个函数，这个函数接受一个React组件作为参数(argument).调用<code>connect()</code>函数时需要配置项.后面我们将会传递配置我们应用的actions和state参数.<br>我们也把<code>connect</code>作为默认配置到处模块.这一点非常重要！现在当我们<code>import Gallery</code>的时候,就不是一个单纯的React组件了,而是一个和Redux关联的组件了.</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2044710-72a9136f9b481bf6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620" alt></p>
<p>如果你观察我们添加进构造器的<code>console.log</code>的输出,就可以看到<code>Gallery</code>组件的属性现在包括了一个<code>dispatch</code>函数.这个地方是<code>connect</code>为我们的应用修改的,这个改动赋予了组件把自己的动作对象(action objects)<code>派发</code>到<code>reducers</code>的能力.</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="SCALA"><figure class="iseeu highlight /scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    export <span class="class"><span class="keyword">class</span> <span class="title">Gallery</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">+    <span class="keyword">this</span>.props.dispatch(&#123;<span class="class"><span class="keyword">type</span></span>: <span class="symbol">'TES</span>T'&#125;);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      images: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure></div>
<p>我们可以在组件的构造器中调用派发功能.你可以在开发者的终端中看到来自reducer的日志声明.看到声明表示我们已经派发了第一个action!.Actions是一个单一的javascript对象,必需有<code>type</code>属性.Actions可以拥有任意数量和种类的其他属性.但是<code>type</code>可以让reducers理解这些动作到底是做什么用的(意译，意思是只有拥有type属性，reducers才知道对state做什么样的修改).</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PF"><figure class="iseeu highlight /pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export <span class="keyword">default</span> function images(<span class="keyword">state</span>, action) &#123;</span><br><span class="line">-  console.<span class="keyword">log</span>(<span class="keyword">state</span>, action)</span><br><span class="line">+  switch(action.type) &#123;</span><br><span class="line">+    case 'TEST':</span><br><span class="line">+      console.<span class="keyword">log</span>('THIS IS ONLY A TEST')</span><br><span class="line">+  &#125;</span><br><span class="line">  return <span class="keyword">state</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p> 总的reducers使用<code>switch代码块</code>过滤有关的消息,<code>Switch</code>语句使用actions的type属性,当一个<code>action</code>和<code>case</code>分支吻合以后,相应的单个reducer就会执行他的具体工作.</p>
<p> 我们的应用现在关联到接收的动作.现在我们需要把<code>Redux</code>-<code>Store</code>提供的<code>state</code>关联到应用中.</p>
<h4 id="默认的应用状态-state"><a href="#默认的应用状态-state" class="headerlink" title="默认的应用状态(state)"></a>默认的应用状态(state)</h4><p> <code>reducer.js</code><br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PF"><figure class="iseeu highlight /pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  const <span class="keyword">default</span>State = &#123;</span><br><span class="line">  images: []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> function images(<span class="keyword">state</span> = <span class="keyword">default</span>State, action) &#123;</span><br><span class="line">  switch(action.type) &#123;</span><br><span class="line">    case 'TEST':</span><br><span class="line">-      console.<span class="keyword">log</span>('THIS IS ONLY A TEST')</span><br><span class="line">+      console.<span class="keyword">log</span>(<span class="keyword">state</span>, action)</span><br><span class="line">+      return <span class="keyword">state</span>;</span><br><span class="line">+    <span class="keyword">default</span>:</span><br><span class="line">+      return <span class="keyword">state</span>;</span><br><span class="line">  &#125;</span><br><span class="line">-  return <span class="keyword">state</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p> 我们创建一个<code>defaultState</code>对象,这个对象返回一个空数组作为images的属性.我们把<code>images</code>函数的参数<code>state</code>设置为默认.如果在test分支中输出日志,将会看到state不是undefined(空数组不是undefined)!reducer需要返回应用的当前state.这点很重要!现在我们没有做任何改变,所以仅仅返回state.注意我们在<code>case</code>中添加了default分支,reducer必须要返回一个state.</p>
<p>在<code>Gallery</code>组件中，我们也可以把state做一定的映射(map)以后再连接到应用.</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PF"><figure class="iseeu highlight /pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">  import React, &#123;Component&#125; <span class="keyword">from</span> 'react'</span><br><span class="line">import &#123;connect&#125; <span class="keyword">from</span> 'react-redux';</span><br><span class="line"></span><br><span class="line">export class Gallery extends Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    super(props);</span><br><span class="line">    this.props.dispatch(&#123;type: 'TEST'&#125;);</span><br><span class="line">+    console.<span class="keyword">log</span>(props);</span><br><span class="line">-    this.<span class="keyword">state</span> = &#123;</span><br><span class="line">-      images: []</span><br><span class="line">-    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">-  componentDidMount() &#123;</span><br><span class="line">-    const API_KEY = 'a46a979f39c49975dbdd23b378e6d3d5';</span><br><span class="line">-    const API_ENDPOINT = `https://api.flickr.com/services/rest/?method=flickr.interestingness.-getList&amp;api_key=$&#123;API_KEY&#125;&amp;format=json&amp;nojsoncallback=<span class="number">1</span>&amp;per_page=<span class="number">5</span>`;-</span><br><span class="line">-</span><br><span class="line">-    fetch(API_ENDPOINT).then((response) =&gt; &#123;</span><br><span class="line">-      return response.json().then((json) =&gt; &#123;</span><br><span class="line">-        const images = json.photos.photo.map((&#123;farm, server, id, secret&#125;) =&gt; &#123; </span><br><span class="line">-            return `https://farm$&#123;farm&#125;.staticflickr.com/$&#123;server&#125;/$&#123;id&#125;_$&#123;secret&#125;.jpg`</span><br><span class="line">-        &#125;);</span><br><span class="line">-</span><br><span class="line">-        this.<span class="built_in">set</span>State(&#123;images, selectedImage: images[<span class="number">0</span>]&#125;);</span><br><span class="line">-      &#125;)</span><br><span class="line">-    &#125;)</span><br><span class="line">-  &#125;</span><br><span class="line">-  handleThumbClick(selectedImage) &#123;</span><br><span class="line">-    this.<span class="built_in">set</span>State(&#123;</span><br><span class="line">-      selectedImage</span><br><span class="line">-    &#125;)</span><br><span class="line">-  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">-    const &#123;images, selectedImage&#125; = this.<span class="keyword">state</span>;</span><br><span class="line">+    const &#123;images, selectedImage&#125; = this.props;</span><br><span class="line">    return (</span><br><span class="line">      <span class="variable">&lt;div className="image-gallery"&gt;</span></span><br><span class="line">        <span class="variable">&lt;div className="gallery-image"&gt;</span></span><br><span class="line">          <span class="variable">&lt;div&gt;</span></span><br><span class="line">            <span class="variable">&lt;img src=&#123;selectedImage&#125; /&gt;</span></span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        <span class="variable">&lt;div className="image-scroller"&gt;</span></span><br><span class="line">          &#123;images.map((image, index) =&gt; (</span><br><span class="line">-            <span class="variable">&lt;div key=&#123;index&#125; onClick=&#123;this.handleThumbClick.bind(this,image)&#125;&gt;</span></span><br><span class="line">+            <span class="variable">&lt;div key=&#123;index&#125;&gt;</span></span><br><span class="line">              <span class="variable">&lt;img src=&#123;image&#125;/&gt;</span></span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          ))&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+function mapStateToProps(<span class="keyword">state</span>) &#123;</span><br><span class="line">+  return &#123;</span><br><span class="line">+    images: <span class="keyword">state</span>.images</span><br><span class="line">+    selectedImage: <span class="keyword">state</span>.selectedImage</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line"></span><br><span class="line">-export <span class="keyword">default</span> connect()(Gallery)</span><br><span class="line">+export <span class="keyword">default</span> connect(mapStateToProps)(Gallery)</span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line">  </span><br><span class="line">  我们将移除连接组件中的所有图片加载和交互逻辑代码,如果你注意看`Gallery`组件的底部代码,你会注意到，我们创建了一个`mapStateToProps`函数,接收一个`<span class="keyword">state</span>`作为参数,返回一个对象,把`<span class="keyword">state</span>.images`映射为`images`属性.`mapStateToProps`做为参数传递给`connect`.</span><br><span class="line">  正如名字暗示的一样,`mapStateToProps`函数接收当前应用的<span class="keyword">state</span>,然后把<span class="keyword">state</span>转变为组件的属性(propertys).如果在构造器中输出props,将会看到images数组是`reducer`返回的默认<span class="keyword">state</span>.</span><br></pre></td></tr></table></figure></div>
<p>   const defaultState = {</p>
<ul>
<li>images: []</li>
</ul>
<ul>
<li>images: [</li>
<li>“<a href="https://farm2.staticflickr.com/1553/25266806624_fdd55cecbc.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1553/25266806624_fdd55cecbc.jpg&quot;</a>,</li>
<li>“<a href="https://farm2.staticflickr.com/1581/25283151224_50f8da511e.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1581/25283151224_50f8da511e.jpg&quot;</a>,</li>
<li>“<a href="https://farm2.staticflickr.com/1653/25265109363_f204ea7b54.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1653/25265109363_f204ea7b54.jpg&quot;</a>,</li>
<li>“<a href="https://farm2.staticflickr.com/1571/25911417225_a74c8041b0.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1571/25911417225_a74c8041b0.jpg&quot;</a>,</li>
<li>“<a href="https://farm2.staticflickr.com/1450/25888412766_44745cbca3.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1450/25888412766_44745cbca3.jpg&quot;</a></li>
<li>],</li>
<li>selectedImage: “<a href="https://farm2.staticflickr.com/1553/25266806624_fdd55cecbc.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1553/25266806624_fdd55cecbc.jpg&quot;</a><br>}</li>
</ul>
<p>export default function images(state = defaultState, action) {<br>  switch(action.type) {<br>    case ‘TEST’:<br>      console.log(state, action)<br>      return state;<br>    default:<br>      return state;<br>  }<br>}<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PF"><figure class="iseeu highlight /pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  </span><br><span class="line">  如果在`<span class="keyword">default</span>State`中更新images数组,你将可以看到一些图片重新出现在gallery中!现在当用户点击缩略图的时候,我们可以反馈选择动作,返回对应的大图.</span><br><span class="line">  </span><br><span class="line"><span class="comment">#### 更新state</span></span><br><span class="line">  怎么操作才能根据新选择的图片更新<span class="keyword">state</span>?</span><br><span class="line">  需要配置reducer监听`IMAGE_SELECTED`动作,借助action携带的信息(payload,有的文章翻译为载荷,载荷怎么理解？手机载荷就是声音，短信和流量数据。如果是卡车就是拉的货物,如果是客车就乘载的乘客,action的载荷就是要让reducer明白你要干什么，需要什么)来更新<span class="keyword">state</span>.</span><br></pre></td></tr></table></figure></div></p>
<p>  const defaultState = {<br>  images: [<br>    “<a href="https://farm2.staticflickr.com/1553/25266806624_fdd55cecbc.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1553/25266806624_fdd55cecbc.jpg&quot;</a>,<br>    “<a href="https://farm2.staticflickr.com/1581/25283151224_50f8da511e.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1581/25283151224_50f8da511e.jpg&quot;</a>,<br>    “<a href="https://farm2.staticflickr.com/1653/25265109363_f204ea7b54.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1653/25265109363_f204ea7b54.jpg&quot;</a>,<br>    “<a href="https://farm2.staticflickr.com/1571/25911417225_a74c8041b0.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1571/25911417225_a74c8041b0.jpg&quot;</a>,<br>    “<a href="https://farm2.staticflickr.com/1450/25888412766_44745cbca3.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1450/25888412766_44745cbca3.jpg&quot;</a><br>  ],<br>  selectedImage: “<a href="https://farm2.staticflickr.com/1553/25266806624_fdd55cecbc.jpg&quot;" target="_blank" rel="noopener">https://farm2.staticflickr.com/1553/25266806624_fdd55cecbc.jpg&quot;</a><br>}</p>
<p>export default function images(state = defaultState, action) {<br>  switch(action.type) {</p>
<ul>
<li>case ‘TEST’:<br>case ‘IMAGE_SELECTED’:</li>
<li>return state;</li>
</ul>
<ul>
<li><p>return {…state, selectedImage: action.image};<br>default:<br>return state;<br>}<br>}</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">现在reducer已经准备接收`IMAGE_SELECTED` action了.在`IMAGE_SELECTED`分支选项内,我们在展开(spreading,ES6的对象操作方法),并重写`selectedImage`属性后,返回一个新state对象.了解更多的`...state`对象操作可以看`ruanyifeng`的书.</span><br></pre></td></tr></table></figure></div>
<p>import React, {Component} from ‘react’<br>import {connect} from ‘react-redux’;</p>
</li>
</ul>
<p>export class Gallery extends Component {</p>
<ul>
<li>constructor(props) {</li>
<li>super(props);</li>
<li>this.props.dispatch({type: ‘TEST’});</li>
<li>console.log(props);</li>
<li>}<br>render() {</li>
<li>const {images, selectedImage} = this.props;</li>
</ul>
<ul>
<li><p>const {images, selectedImage, dispatch} = this.props;</p>
<p>return (<br> <div classname="image-gallery"><br>   <div classname="gallery-image"></div></div></p>
<pre><code>&lt;div&gt;
  &lt;img src={selectedImage} /&gt;
&lt;/div&gt;
</code></pre><p>   <br>   <div classname="image-scroller"></div></p>
<pre><code>{images.map((image, index) =&gt; (
</code></pre></li>
</ul>
<ul>
<li><div key="{index}"></div></li>
</ul>
<ul>
<li><div key="{index}" onclick="{()" => dispatch({type:’IMAGE_SELECTED’, image})}&gt;<br> <img src="{image}/"><br></div><br>))}<br><br><br>)<br>}<br>}</li>
</ul>
<p>function mapStateToProps(state) {<br>  return {<br>    images: state.images,<br>    selectedImage: state.selectedImage<br>  }<br>}</p>
<p>export default connect(mapStateToProps)(Gallery)<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  在`Gallery`组件中,我们将会在组件的属性中定义`dispatch`在`onClick`函数体中调用他,现在我们从便利角度考虑把他们放在一起,但是两者功能是一样的.一旦我们点击了缩略图,他将会通过reducer更新大图.</span><br><span class="line"> 使用dispatch可以很方便的创建通用actions,但是很快我们会需要重用命名好的actions.为了这样做,可以使用”action creators”.</span><br><span class="line"> </span><br><span class="line">#### Action Creators</span><br><span class="line"> Action creators函数返回配置好的action对象.我们在`action.js`中添加第一个action creator.</span><br><span class="line"> </span><br><span class="line"> `action.js`</span><br></pre></td></tr></table></figure></div></p>
<p> export const IMAGE_SELECTED = ‘IMAGE_SELECTED’;</p>
<p>export function selectImage(image) {<br>  return {<br>    type: IMAGE_SELECTED,<br>    image<br>  }<br>}<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="SQF"><figure class="iseeu highlight /sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这个方法经过export以后,可以直接在任何需要创建`selectImage` <span class="built_in">action</span>地方导入!`selectImage`是纯函数，只能返回数据.他接收一个<span class="built_in">image</span>作为参数,把<span class="built_in">image</span>添加到<span class="built_in">action</span>对象中，并返回.</span><br><span class="line"></span><br><span class="line">&gt;注意:我们正在返回一个单纯的javascript object,但是`<span class="built_in">image</span>`的属性可能很古怪，如果你以前没有碰到这样的样式.从ES6的角度出发,如果你给一个对象传递一个类似这样的属性,隐含的意思是把`<span class="built_in">image</span>:<span class="string">'任何image包含的值'</span>`添加到最终返回的对象.超级好用!</span><br></pre></td></tr></table></figure></div></p>
<p> import  * as GalleryActions from ‘./actions.js’;<br>[…]<br>onClick={() =&gt; dispatch(GalleryActions.selectImage(image))}<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">this isn’t much than just using `dispatch` though.</span><br><span class="line"></span><br><span class="line">幸运的是,这个模式很普遍,Redux在`bindActionCreators`函数里提供了一个更好的办法来完成这个功能.</span><br></pre></td></tr></table></figure></div></p>
<p> import React, {Component} from ‘react’<br>import {connect} from ‘react-redux’;</p>
<ul>
<li><p>import {bindActionCreators} from ‘redux’;</p>
</li>
<li><p>import  * as GalleryActions from ‘./actions.js’;</p>
</li>
</ul>
<p>export class Gallery extends Component {<br>  constructor(props) {<br>    super(props);<br>    this.props.dispatch({type: ‘TEST’});<br>    console.log(props);<br>  }<br>  handleThumbClick(selectedImage) {<br>    this.setState({<br>      selectedImage<br>    })<br>  }<br>  render() {</p>
<ul>
<li>const {images, selectedImage, dispatch} = this.props;</li>
</ul>
<ul>
<li>const {images, selectedImage, selectImage} = this.props;<br>return (<br> <div classname="image-gallery"><br>   <div classname="gallery-image"><pre><code>&lt;div&gt;
  &lt;img src={selectedImage} /&gt;
&lt;/div&gt;
</code></pre>   </div><br>   <div classname="image-scroller"><pre><code>{images.map((image, index) =&gt; (
</code></pre></div></div></li>
</ul>
<ul>
<li><div key="{index}" onclick="{()" => dispatch({type:’IMAGE_SELECTED’, image})}&gt;</div></li>
</ul>
<ul>
<li><div key="{index}" onclick="{()" => selectImage(image)}&gt;<br> <img src="{image}/"><br></div><br>))}<br><br><br>)<br>}<br>}</li>
</ul>
<p>function mapStateToProps(state) {<br>  return {<br>    images: state.images,<br>    selectedImage: state.selectedImage<br>  }<br>}</p>
<p>+function mapActionCreatorsToProps(dispatch) {</p>
<ul>
<li>return bindActionCreators(GalleryActions, dispatch);<br>+}</li>
</ul>
<p>-export default connect(mapStateToProps)(Gallery)<br>+export default connect(mapStateToProps, mapActionCreatorsToProps)(Gallery)<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PROLOG"><figure class="iseeu highlight /prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> 我们已经添加了<span class="string">`mapActionCreatorsToProps`</span>函数,他接收<span class="string">`dispatch`</span>函数作为参数.返回<span class="string">`bindActionCreators`</span>的调用结果,<span class="string">`GalleryActions`</span>作为<span class="string">`bindActionCreators`</span>的参数.现在如果你输出属性日志,就看不到<span class="string">`dispatch`</span>作为参数,<span class="string">`selectImage`</span>直接可以使用了.(这里相当于对dispatch和action进行了包装).</span><br><span class="line"> </span><br><span class="line"> 现在回顾一下,我们做了几件事:</span><br><span class="line"> - 创建了一个reducer包含应用的默认初始状态(initial state),并且监听actions的执行.</span><br><span class="line"> - 创建了一个store,把reducer具体化,提供一个分发器(dispatcher)可以分发action.</span><br><span class="line"> - 把我们的<span class="symbol">Gallery</span>组件关联到store的state.</span><br><span class="line"> - 把store的state映射为属性(property)，传递给<span class="symbol">Gallery</span>.</span><br><span class="line"> - 映射一个动作创建器,<span class="symbol">Gallery</span>可以简单的调用<span class="string">`selectImage(image)`</span>,分发动作,应用状态将会更新.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">那么，我们怎么才能使用这些模式从远程资源加载数据呢？</span><br><span class="line"></span><br><span class="line">这个过程将会非常有趣!</span><br><span class="line"></span><br><span class="line">#### 异步活动？</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">你可能在参加函数式编程的时候听说过”副作用”(side effects)这个名词,side effects是发生在应用的范围之外的东西.在我们舒适的肥皂泡里,side effect根本不是问题,但是当我们要到达一个远程资源,肥皂泡就被穿透了.有些事情我们就控制不了了,我们必须接受这个事实.(根据这段话，side effect 翻译为意想不到的事情，出乎意料的不受控制的事情更好)</span><br><span class="line"></span><br><span class="line">在<span class="symbol">Redux</span>里,reducer没有<span class="symbol">Side</span> effects.这意味着reducers不处理我们应用中的异步活动.我们不能使用reducers加载远程数据,因为reducers是纯函数,没有side effects.</span><br><span class="line"></span><br><span class="line"><span class="symbol">Redux</span>很棒,如果你的应用里没有任何异步活动，你可以停下来,不用再往下看了.</span><br><span class="line">如果你创建的应用比较大,可能你会从服务端加载数据,这时,当然要使用异步方式.</span><br><span class="line"></span><br><span class="line">&gt;**注意**： <span class="symbol">Redux</span>其中一个最酷的地方是他非常小巧.他试图解决有限范围内的问题.大多数的应用需要解决很多问题!万幸,<span class="symbol">Reduc</span>提供中间件概念,中间件存在于action-&gt;reducer-&gt;store的三角关系中,通过中间件的方式,可以导入诸如远程数据异步加载类似的功能.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">其中一个方法是使用<span class="string">`thunks`</span>对象,在<span class="symbol">Redux</span>中有 redux-thunk 中间件.<span class="symbol">Thunks</span>非常厉害，但是可能会导致actions的序列很复杂,测试起来也是很大的挑战.</span><br><span class="line"></span><br><span class="line">考虑到我们的 图片浏览程序.当应用加载是,需要做:</span><br><span class="line">- 从服务器请求图片数组</span><br><span class="line">- 当图片加载完毕,显示提示消息</span><br><span class="line">- 当远程数据返回以后,选择初始图片显示</span><br><span class="line">- 处理可能出现的错误</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这些事件都要在用户点击应用里的任何元素之前完成!</span><br><span class="line">我们该怎么做呢？</span><br><span class="line">redux-saga就是为此而诞生,为我们的应用提供绝佳的服务.</span><br><span class="line"></span><br><span class="line">redux-sage</span><br><span class="line"></span><br><span class="line">redux-sage可以在<span class="symbol">Redux</span>应用中操作异步actions.他提供中间件和趁手的方法使构建复杂的异步操作流程轻而易举.</span><br><span class="line"></span><br><span class="line">一个saga是一个<span class="symbol">Generator</span>(生成器),<span class="symbol">Generator</span>函数是<span class="symbol">ES2015</span>新添加的特性.可能是你第一次遇到<span class="symbol">Generator</span>函数,这样你会觉得有点古怪,可以参考(ruanyifeng文章).不要苦恼，如果你对此仍然很抓耳挠腮.使用redux-sage你不需要javascript异步编程的博士学位.</span><br><span class="line"></span><br><span class="line">因为使用了generators的缘故,我们能创建一个顺序执行的命令序列，用来描述复杂的异步操作流程(workflows).整个图片的加载流程序列如下：</span><br></pre></td></tr></table></figure></div></p>
<p>   export function* loadImages() {<br>  try {<br>    const images = yield call(fetchImages);<br>    yield put({type: ‘IMAGES_LOADED’, images})<br>    yield put({type: ‘IMAGE_SELECTED’, image: images[0]})<br>  } catch(error) {<br>    yield put({type: ‘IMAGE_LOAD_FAILURE’, error})<br>  }<br>}</p>
<p>export function* watchForLoadImages() {<br>  while(true) {<br>    yield take(‘LOAD_IMAGES’);<br>    yield call(loadImages);<br>  }<br>}<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="CLEAN"><figure class="iseeu highlight /clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">   </span><br><span class="line">#### 第一个saga</span><br><span class="line"></span><br><span class="line">我们将开始一个简单的saga实例,然后配置他连接到我们的应用.在`src`创建一个文件</span><br><span class="line">`saga.js`</span><br></pre></td></tr></table></figure></div></p>
<p>   export function* sayHello() {<br>  console.log(‘hello’);<br>}<br>  <div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">___</span><br><span class="line">我们的saga是一个简单的generator函数.函数后面的`*`作为标志,他也被叫做”super star”.</span><br><span class="line"></span><br><span class="line">现在在`main.js`文件中导入新函数,并且执行他.</span><br></pre></td></tr></table></figure></div></p>
<p>  import “babel-polyfill”;</p>
<p>import React from ‘react’;<br>import ReactDOM from ‘react-dom’;</p>
<p>import Gallery from ‘./Gallery’;</p>
<p>import { createStore } from ‘redux’<br>import {Provider} from ‘react-redux’;<br>import reducer from ‘./reducer’</p>
<p>+import {sayHello} from ‘./sagas’;<br>+sayHello();</p>
<p>const store = createStore(reducer);</p>
<p>ReactDOM.render(<br>  <provider store="{store}"><br>    <gallery><br>  </gallery></provider>,<br>  document.getElementById(‘root’)<br>);<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PROLOG"><figure class="iseeu highlight /prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">不管你盯住终端多长时间,“hello”永远不会出现.</span><br><span class="line">这是因为<span class="string">`sayHello`</span>是一个generator！<span class="symbol">Generator</span> 不会立即执行.如果你把代码该为<span class="string">`sayHello().next();`</span>你的“hello”就出现了.不用担心,我们不会总是调用<span class="string">`next`</span>.正如<span class="symbol">Redux</span>,redux-saga用来消除应用开发中的痛苦.</span><br><span class="line"></span><br><span class="line">配置 redux-sage</span><br></pre></td></tr></table></figure></div></p>
<p>   import “babel-polyfill”;</p>
<p>import React from ‘react’;<br>import ReactDOM from ‘react-dom’;</p>
<p>import Gallery from ‘./Gallery’;</p>
<p>-import { createStore } from ‘redux’<br>+import { createStore, applyMiddleware } from ‘redux’<br>+import createSagaMiddleware from ‘redux-saga’<br>import {Provider} from ‘react-redux’;<br>import reducer from ‘./reducer’</p>
<p>import {sayHello} from ‘./sagas’;<br>-sayHello()</p>
<p>-const store = createStore(reducer);<br>+const store = createStore(</p>
<ul>
<li>reducer,</li>
<li>applyMiddleware(createSagaMiddleware(sayHello))<br>+);</li>
</ul>
<p>ReactDOM.render(<br>  <provider store="{store}"><br>    <gallery><br>  </gallery></provider>,<br>  document.getElementById(‘root’)<br>);<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  我们已从Redux导入了`applyMiddleware`函数.从redux-saga导入`createSagaMiddleware`函数.当我们创建store的时候,我们需要通过中间件提供Redux需要的功能.在这个实例中,我们会调用`applyMiddleware`函数,这个函数返回`createSagaMiddleware(sayHello)`的结果.在幕后,redux-saga加载`sayHello`函数,仪式性的调用`next`函数.</span><br><span class="line">  </span><br><span class="line">  应该可以在终端中看到提示消息了.</span><br><span class="line">  现在让我们构建加载图片的saga</span><br><span class="line">  </span><br><span class="line">#### 通过Saga加载图片数据</span><br><span class="line"></span><br><span class="line">我们将删除出sayHello saga,使用`loadImages` saga</span><br></pre></td></tr></table></figure></div></p>
<p>  -export function* sayHello() {</p>
<ul>
<li>console.log(‘hello’);<br>-}</li>
</ul>
<p>+export function* loadImages() {</p>
<ul>
<li>console.log(‘load some images please’)<br>+}<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JAVASCRIPT"><figure class="iseeu highlight /javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">不要忘了更新<span class="string">`main.js`</span></span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<p>import “babel-polyfill”;</p>
<p>import React from ‘react’;<br>import ReactDOM from ‘react-dom’;</p>
<p>import Gallery from ‘./Gallery’;</p>
<p>import { createStore, applyMiddleware } from ‘redux’<br>import {Provider} from ‘react-redux’;<br>import createSagaMiddleware from ‘redux-saga’<br>import reducer from ‘./reducer’</p>
<p>-import {sayHello} from ‘./sagas’;<br>+import {loadImages} from ‘./sagas’;</p>
<p>const store = createStore(<br>  reducer,</p>
<ul>
<li>applyMiddleware(createSagaMiddleware(sayHello))</li>
</ul>
<ul>
<li>applyMiddleware(createSagaMiddleware(loadImages))<br>);</li>
</ul>
<p>ReactDOM.render(<br>  <provider store="{store}"><br>    <gallery><br>  </gallery></provider>,<br>  document.getElementById(‘root’)<br>);<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">现在saga已经加载,在`saga.js`中添加`fetchImages`方法</span><br></pre></td></tr></table></figure></div></p>
<pre><code>const API_KEY = &apos;a46a979f39c49975dbdd23b378e6d3d5&apos;;
</code></pre><p>const API_ENDPOINT = <code>https://api.flickr.com/services/rest/?method=flickr.interestingness.getList&amp;api_key=${API_KEY}&amp;format=json&amp;nojsoncallback=1&amp;per_page=5</code>;</p>
<p>const fetchImages = () =&gt; {<br>  return fetch(API_ENDPOINT).then(function (response) {<br>    return response.json().then(function (json) {<br>      return json.photos.photo.map(<br>        ({farm, server, id, secret}) =&gt; <code>https://farm${farm}.staticflickr.com/${server}/${id}_${secret}.jpg</code><br>      );<br>    })<br>  })<br>};</p>
<p>export function* loadImages() {<br>  const images = yield fetchImages();<br>  console.log(images)<br>}<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> `fetchImages`方法返回一个promise对象.我们将调用`fetchImages`,但是现在我们要使用`yield`关键字.通过黑暗艺术和巫术,generators理解Promise对象,正如终端输出的日志显示,我们已经收获了一个图片URLs的数组.看看`loadImages`的代码,他看起来像是典型的同步操作代码.`yield`关键字是秘制调味酱,让我们的代码用同步格式执行异步操作活动.</span><br><span class="line">  </span><br><span class="line">#### 封装我们的异步API请求.</span><br><span class="line"> </span><br><span class="line"> 首先来定义一下需要使用的api.他没有什么特殊的地方,实际上他和早先加载Flickr images的代码是相同的.我们创建`flickr.js`文件</span><br></pre></td></tr></table></figure></p>
<p>   const API_KEY = ‘a46a979f39c49975dbdd23b378e6d3d5’;<br>const API_ENDPOINT = <code>https://api.flickr.com/services/rest/?method=flickr.interestingness.getList&amp;api_key=${API_KEY}&amp;format=json&amp;nojsoncallback=1&amp;per_page=5</code>;</p>
<p>export const fetchImages = () =&gt; {<br>  return fetch(API_ENDPOINT).then(function (response) {<br>    return response.json().then(function (json) {<br>      return json.photos.photo.map(<br>        ({farm, server, id, secret}) =&gt; <code>https://farm${farm}.staticflickr.com/${server}/${id}_${secret}.jpg</code><br>      );<br>    })<br>  })<br>};<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">严格意义上来说,不需要这么做,但是这会带来一定的好处.我们处在应用的边缘(boundaries of our application,意思是说在这里的代码可能是很多和远程服务器交互的代码，可能逻辑会很复杂),事情都有点乱.通过封装和远程API交互的逻辑,我们的代码将会很整洁,很容易更新.如果需要抹掉图片服务也会出奇的简单.</span><br><span class="line"></span><br><span class="line">我们的`saga.js`看起来是这个样子：</span><br></pre></td></tr></table></figure></p>
<p>  import {fetchImages} from ‘./flickr’;</p>
<p>export function* loadImages() {<br>  const images = yield fetchImages();<br>  console.log(images)<br>}<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PF"><figure class="iseeu highlight /pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">我们仍然需要在saga外获取数据,并且进入应用的<span class="keyword">state</span>(使用异步获取的远程数据更新<span class="keyword">state</span>).为了处理这个问题,我们将使用”effects”.</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 从saga来更新应用</span></span><br><span class="line"></span><br><span class="line">我们可以通过`dispatch`或者store作为参数来调用saga,但是这个方法时间一长就会给人造成些许的困扰.我们选择采用redux-saga提供的`put`方法.</span><br><span class="line">首先我们更新`reducer.js`操作一个新的action类型`IMAGES_LOADED`.</span><br></pre></td></tr></table></figure></div></p>
<p>const defaultState = {</p>
<ul>
<li>images: []<br>}</li>
</ul>
<p>export default function images(state = defaultState, action) {<br>  switch(action.type) {<br>    case ‘IMAGE_SELECTED’:<br>      return {…state, selectedImage: action.image};</p>
<ul>
<li>case ‘IMAGES_LOADED’:</li>
<li><p>return {…state, images: action.images};<br>default:<br>return state;<br>}<br>}     </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">我们添加了新的分支,并从`defaultState`中删除了硬编码的URLs数据.`IMAGES_LOADED`分支现在返回一个更新的state,包含action的image数据.</span><br><span class="line">下一步我们更新saga:</span><br></pre></td></tr></table></figure>
<p>import {fetchImages} from ‘./flickr’;<br>+import {put} from ‘redux-saga/effects’;</p>
</li>
</ul>
<p>export function* loadImages() {<br>  const images = yield fetchImages();</p>
<ul>
<li>yield put({type: ‘IMAGES_LOADED’, images})<br>}<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">导入`put`以后,我们在`loadImages`添加另外一行.他`yield` `put`函数调用的返回结果.在幕后,redux-saga 分发这些动作,reducer接收到了消息!</span><br><span class="line">	   怎样才能使用特定类型的action来触发一个saga?</span><br><span class="line">	   </span><br><span class="line">#### 使用actions来触发saga工作流</span><br><span class="line"></span><br><span class="line">Sagas变得越来越有用,因为我们有能力使用redux actions来触发工作流.当我们这样做,saga会在我们的应用中表现出更大的能力.首先我们创建一个新的saga.`watchForLoadImages`.</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<p>import {fetchImages} from ‘./flickr’;<br>-import {put} from ‘redux-saga/effects’;<br>+import {put, take} from ‘redux-saga/effects’;</p>
<p>export function* loadImages() {<br>  const images = yield fetchImages();<br>  yield put({type: ‘IMAGES_LOADED’, images})<br>}</p>
<p>+export function* watchForLoadImages() {</p>
<ul>
<li>while(true) {</li>
<li>yield take(‘LOAD_IMAGES’);</li>
<li>yield loadImages();</li>
<li>}<br>+}<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="LASSO"><figure class="iseeu highlight /lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">新的saga使用的是<span class="keyword">while</span>来保持一直激活和等待调用状态.在循环的内部,我们生成(<span class="keyword">yield</span>)一个redux<span class="params">-sage</span>调用方法:<span class="string">`take`</span>.<span class="keyword">Take</span>方法监听任何类型的actions,他也会使saga接受下一个<span class="keyword">yield</span>.在上面的例子中我们调用了一个方法<span class="string">`loadImages`</span>,初始化图片加载.</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<p>import “babel-polyfill”;</p>
<p>import React from ‘react’;<br>import ReactDOM from ‘react-dom’;</p>
<p>import Gallery from ‘./Gallery’;</p>
<p>import { createStore, applyMiddleware } from ‘redux’<br>import {Provider} from ‘react-redux’;<br>import createSagaMiddleware from ‘redux-saga’<br>import reducer from ‘./reducer’</p>
<p>-import {loadImages} from ‘./sagas’;<br>+import {loadImages} from ‘./watchForLoadImages’;</p>
<p>const store = createStore(<br>  reducer,</p>
<ul>
<li>applyMiddleware(createSagaMiddleware(loadImages))</li>
</ul>
<ul>
<li>applyMiddleware(createSagaMiddleware(watchForLoadImages))<br>);</li>
</ul>
<p>ReactDOM.render(<br>  <provider store="{store}"><br>    <gallery><br>  </gallery></provider>,<br>  document.getElementById(‘root’)<br>);<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">更新了`main.js`以后,应用不再加载图片,我们需要在action creators中添加`loadImages`的`action`.</span><br></pre></td></tr></table></figure></div></p>
<p>export const IMAGE_SELECTED = ‘IMAGE_SELECTED’;<br>+const LOAD_IMAGES = ‘LOAD_IMAGES’;</p>
<p>export function selectImage(image) {<br>  return {<br>    type: IMAGE_SELECTED,<br>    image<br>  }<br>}</p>
<p>+export function loadImages() {</p>
<ul>
<li>return {</li>
<li>type: LOAD_IMAGES</li>
<li>}<br>+}<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">因为我们已经绑定了action creators(Action创建器),我们只需要在`Gallery`组件中调用这个action就可以了.</span><br><span class="line"></span><br><span class="line">#### block(阻塞)和no-blocking(非阻塞)效应</span><br><span class="line">现在我们的引用工作的足够好了,但是可能还有更多的问题需要考虑.`watchForLoadImages` saga包含 block effects.那么这到底是什么意思呢？这意味着在工作流中我们只能执行一次`LOAD_IMAGES`!在诸如我们现在构建的小型应用一样,这一点不太明显,实际上我们也仅仅加载了一次图片集.</span><br><span class="line">实际上，普遍的做法是使用`fork` effect 代替  `yield` 来加载图片</span><br><span class="line">.</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<p>export function* watchForLoadImages() {<br>  while(true) {<br>    yield take(‘LOAD_IMAGES’);</p>
<ul>
<li>yield loadImages();</li>
</ul>
<ul>
<li>yield fork(loadImages); //be sure to import it!<br>}<br>}<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="HTTP"><figure class="iseeu highlight /http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">使用`fork`助手(helper)函数,`watchForLoadImages`就变成了非阻塞saga了,再也不用考虑他是不是以前掉用过.redux-sagas 提供两个helpers,`takeEvery`和`takeLastest`（takeEvery监听多次action，不考虑是不是同一种action type,takeLatest只处理同一种action type的最后一次调用）.</span><br><span class="line">####选择默认的图片</span><br><span class="line"><span class="attribute">Sagas按照队列来执行acitons,所以添加更多的saga也很容易.</span></span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<p>import {fetchImages} from ‘./flickr’;<br>import {put, take, fork} from ‘redux-saga/effects’;</p>
<p>export function* loadImages() {<br>  const images = yield fetchImages();<br>  yield put({type: ‘IMAGES_LOADED’, images})</p>
<ul>
<li>yield put({type: ‘IMAGE_SELECTED’, image: images[0]})<br>}</li>
</ul>
<p>export function* watchForLoadImages() {<br>  while(true) {<br>    yield take(‘LOAD_IMAGES’);<br>    yield fork(loadImages);<br>  }<br>}<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在 `loadImages`工作流上,我们可以yield put函数调用,action type是`IMAGE_SELECTED`.发送我们选择的图片(在这个例子中，发送的仅仅是图片的url的字符串).</span><br><span class="line">#### 错误处理</span><br><span class="line">如果在saga循环内部出现错误,我们要考虑提醒应用做出合理的回应.所有流程包装到try/catch语句块里就可以实现,捕获错误以后`put`一个提示信息作为`IMAGE_LOAD_FAILURE` action的内容.</span><br></pre></td></tr></table></figure></div></p>
<p>import {fetchImages} from ‘./flickr’;<br>import {put, take, fork} from ‘redux-saga/effects’;</p>
<p>export function* loadImages() {</p>
<ul>
<li>try {<br> const images = yield fetchImages();<br> yield put({type: ‘IMAGES_LOADED’, images})<br> yield put({type: ‘IMAGE_SELECTED’, image: images[0]})</li>
<li>} catch(error) {</li>
<li>yield put({type: ‘IMAGE_LOAD_FAILURE’, error})</li>
<li>}<br>}</li>
</ul>
<p>export function* watchForLoadImages() {<br>  while(true) {<br>    yield take(‘LOAD_IMAGES’);<br>    yield fork(loadImages);<br>  }<br>}<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="MARKDOWN"><figure class="iseeu highlight /markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">#### Sagas的测试</span></span><br><span class="line"></span><br><span class="line">在应用中使用Redux,测试变得相当的舒服. 看看我们的[<span class="string">鹅蛋头系列课程</span>](<span class="link">https://egghead.io/series/react-testing-cookbook</span>),可以了解到很多React的测试技术.</span><br><span class="line">使用Redux-saga在棒的一个方面就是异步代码测试很容易.测试javascript异步代码真是一件苦差事.有了saga,我们不需要跳出引用的核心代码.Saga把javascript的痛点都抹掉了.是不是意味着我们要写更多的测试?对的.</span><br><span class="line"></span><br><span class="line">我们会使用<span class="code">`tape`</span>组件,首先做一些配置工作.</span><br></pre></td></tr></table></figure></div></p>
<p>import test from ‘tape’;<br>import {put, take} from ‘redux-saga/effects’<br>import {watchForLoadImages, loadImages} from ‘./sagas’;<br>import {fetchImages} from ‘./flickr’;</p>
<p>test(‘watchForLoadImages’, assert =&gt; {<br>  const generator = watchForLoadImages();</p>
<p>  assert.end();<br>});<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="ERLANG"><figure class="iseeu highlight /erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">添加所有需要的组件,现在我们添加一个测试.这个测试接收一个名称和一个函数作为形参.在测试的函数体内部代码块,我们创建了一个saga生成器代码实例.在这个实例里面我们尅是测试saga的每一个动作.</span><br></pre></td></tr></table></figure></div></p>
<p>import test from ‘tape’;<br>import {put, take} from ‘redux-saga/effects’<br>import {watchForLoadImages, loadImages} from ‘./sagas’;<br>import {fetchImages} from ‘./flickr’;</p>
<p>test(‘watchForLoadImages’, assert =&gt; {<br>  const generator = watchForLoadImages();</p>
<ul>
<li>assert.deepEqual(</li>
<li>generator.next().value,</li>
<li>false,</li>
<li>‘watchForLoadImages should be waiting for LOAD_IMAGES action’</li>
<li><p>);</p>
<p>assert.end();<br>});</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`assert.deepEqual`方法接收两个值,检查一下他们是不是深度相同(js对象的概念).第一行代码是`generator.next().value`的调用,这个调用使生成器从暂停中恢复,得到值.下一个值单单是一个`false`.我想看到他失败,最后一个参数描述了测试期待的行为.</span><br><span class="line"><span class="symbol">在项目文件夹中命令行运行`npm test`看看结果:</span></span><br></pre></td></tr></table></figure></div>
<p>import test from ‘tape’;<br>import {put, take} from ‘redux-saga/effects’<br>import {watchForLoadImages, loadImages} from ‘./sagas’;<br>import {fetchImages} from ‘./flickr’;</p>
</li>
</ul>
<p>test(‘watchForLoadImages’, assert =&gt; {<br>  const generator = watchForLoadImages();</p>
<ul>
<li>assert.deepEqual(</li>
<li>generator.next().value,</li>
<li>false,</li>
<li>‘watchForLoadImages should be waiting for LOAD_IMAGES action’</li>
<li><p>);</p>
<p>assert.end();<br>});</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">测试结果和预期的一样失败,结果有点意思.实际的结论是`&#123;TAKE:</span>'LOAD_IMAGES'&#125;`,这是我们调用`take('LOAD_IMAGES')`受到的结果.实际上,我们的saga’可以yield一个对象来代替调用`take`.但是`take`添加了一些代码,让我们少敲些代码.</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<p>import test from ‘tape’;<br>import {put, take} from ‘redux-saga/effects’<br>import {watchForLoadImages, loadImages} from ‘./sagas’;<br>import {fetchImages} from ‘./flickr’;</p>
<p>test(‘watchForLoadImages’, assert =&gt; {<br>  const generator = watchForLoadImages();</p>
<p>  assert.deepEqual(<br>    generator.next().value,</p>
<ul>
<li>false</li>
</ul>
<ul>
<li><p>take(‘LOAD_IMAGES’),<br>‘watchForLoadImages should be waiting for LOAD_IMAGES action’<br>);</p>
<p>assert.end();<br>});</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">我们简单的调用`take`函数,就可以得到期待的结果了.</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<p>import test from ‘tape’;<br>import {put, take} from ‘redux-saga/effects’<br>import {watchForLoadImages, loadImages} from ‘./sagas’;<br>import {fetchImages} from ‘./flickr’;</p>
<p>test(‘watchForLoadImages’, assert =&gt; {<br>  const generator = watchForLoadImages();</p>
<p>  assert.deepEqual(<br>    generator.next().value,<br>    take(‘LOAD_IMAGES’),<br>    ‘watchForLoadImages should be waiting for LOAD_IMAGES action’<br>  );</p>
<ul>
<li>assert.deepEqual(</li>
<li>gen.next().value,</li>
<li>false,</li>
<li>‘watchForLoadImages should call loadImages after LOAD_IMAGES action is received’</li>
<li><p>);</p>
<p>assert.end();<br>});</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="JAVASCRIPT"><figure class="iseeu highlight /javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">下一个测试使我们确信<span class="string">`loadImages`</span>saga在流程的下一个阶段会被自动调用.</span><br><span class="line">我们需要一个 <span class="literal">false</span>来检查结果.</span><br><span class="line">更新一下saga代码,<span class="keyword">yield</span>一个<span class="string">`loadImages`</span> saga:</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<p>export function* watchForLoadImages() {<br>  while(true) {<br>    yield take(‘LOAD_IMAGES’);</p>
<ul>
<li>yield loadImages();</li>
</ul>
<ul>
<li>yield fork(loadImages); //be sure to import it!<br>}<br>}<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">现在运行测试,将会看到下面结果：</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<h2 id="✖-watchForLoadImages-should-call-loadImages-after-LOAD-IMAGES-action-is-received"><a href="#✖-watchForLoadImages-should-call-loadImages-after-LOAD-IMAGES-action-is-received" class="headerlink" title="✖ watchForLoadImages should call loadImages after LOAD_IMAGES action is received"></a>✖ watchForLoadImages should call loadImages after LOAD_IMAGES action is received</h2><p>  operator: deepEqual<br>  expected: |-<br>    false<br>  actual: |-<br>    { _invoke: [Function: invoke] }<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">哼！`&#123; _invoke: [Function:</span> invoke] &#125;`绝对不是我们yield take想要的结果.</span><br><span class="line">有问题.幸运的是redux-saga可以使用诸如`fork`一样的`effects`来解决这个问题.`fork`,`take`和其他的effect方法返容易满足测试要求的简单对象.这些effects返回的对象是一个指导redux-saga进行任务执行的集合.这一点对于测试来说非常的优雅,因为我们不用担心类似远程服务请求的副作用.有了redux-saga,我们把注意点放到请求执行的命令上.</span><br><span class="line">下面让我们更新一下saga,再一次使用`fork`.</span><br></pre></td></tr></table></figure></div></p>
<p>export function* watchForLoadImages() {<br>  while(true) {<br>    yield take(‘LOAD_IMAGES’);</p>
<ul>
<li>yield loadImages();</li>
</ul>
<ul>
<li><p>yield fork(loadImages);</p>
<p>}<br>}</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">这里使用`yield fork(loadImages)`直接代替`loadImages`.需要注意的是我们还没有执行`loadImages`,而是作为参数传递给`fork`.</span><br><span class="line">再次运行`npm test`.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="✖-watchForLoadImages-should-call-loadImages-after-LOAD-IMAGES-action-is-received-1"><a href="#✖-watchForLoadImages-should-call-loadImages-after-LOAD-IMAGES-action-is-received-1" class="headerlink" title="✖ watchForLoadImages should call loadImages after LOAD_IMAGES action is received"></a>✖ watchForLoadImages should call loadImages after LOAD_IMAGES action is received</h2><p>  operator: deepEqual<br>  expected: |-<br>    false<br>  actual: |-<br>    { FORK: { args: [], context: null, fn: [Function: loadImages] } }<br><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="ERLANG"><figure class="iseeu highlight /erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">结果得到了一个单纯对象而不是一个函数调用.函数在浏览器端也同时加载了,但是我们现在可以轻松的在saga 工作流里测试这个步骤.</span><br></pre></td></tr></table></figure></div></p>
<p>import test from ‘tape’;<br>import {put, take} from ‘redux-saga/effects’<br>import {watchForLoadImages, loadImages} from ‘./sagas’;<br>import {fetchImages} from ‘./flickr’;</p>
<p>test(‘watchForLoadImages’, assert =&gt; {<br>  const generator = watchForLoadImages();</p>
<p>  assert.deepEqual(<br>    generator.next().value,<br>    take(‘LOAD_IMAGES’),<br>    ‘watchForLoadImages should be waiting for LOAD_IMAGES action’<br>  );</p>
<p>  assert.deepEqual(<br>    generator.next().value,</p>
<ul>
<li>false,</li>
</ul>
<ul>
<li><p>yield fork(loadImages),<br>‘watchForLoadImages should call loadImages after LOAD_IMAGES action is received’<br>);</p>
<p>assert.end();<br>});</p>
<div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true" data-rel="AUTOHOTKEY"><figure class="iseeu highlight /autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">测试`loadImages`saga是一样的,只需要把`yield fetchImages`更新为`yield fork(fetchImages)`.</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<p>test(‘loadImages’, assert =&gt; {<br>  const gen = loadImages();</p>
<p>  assert.deepEqual(<br>    gen.next().value,<br>    call(fetchImages),<br>    ‘loadImages should call the fetchImages api’<br>  );</p>
<p>  const images = [0];</p>
<p>  assert.deepEqual(<br>    gen.next(images).value,<br>    put({type: ‘IMAGES_LOADED’, images}),<br>    ‘loadImages should dispatch an IMAGES_LOADED action with the images’<br>  );</p>
<p>  assert.deepEqual(<br>    gen.next(images).value,<br>    put({type: ‘IMAGE_SELECTED’, image: images[0]}),<br>    ‘loadImages should dispatch an IMAGE_SELECTED action with the first image’<br>  );</p>
<p>  const error = ‘error’;</p>
<p>  assert.deepEqual(<br>    gen.throw(error).value,<br>    put({type: ‘IMAGE_LOAD_FAILURE’, error}),<br>    ‘loadImages should dispatch an IMAGE_LOAD_FAILURE if an error is thrown’<br>  );</p>
<p>  assert.end();<br>});<br><code>`</code></p>
<p>特别注意最后一个<code>assert</code>.这个断言测试使用异常捕获代替生成器函数的next方法.另一个非常酷的地方是：可以传值.注意看代码,我们创建了<code>images</code>常量,并且传递到next函数.saga可以在接下来的任务序列中使用传递的值.<br> 太棒了,这种方法是测试异步编程的程序员梦寐以求的技术.</p>
<h5 id="接下来做什么？"><a href="#接下来做什么？" class="headerlink" title="接下来做什么？"></a>接下来做什么？</h5><p> 你可以<a href="https://github.com/joelhooks/egghead-react-redux-image-gallery" target="_blank" rel="noopener">fork一下这个例子的代码</a>.</p>
<p> 如果你想扩充这个应用,可以做一下几个方面的工作.</p>
<ul>
<li>做一个幻灯显示下一张要显示的图片</li>
<li>允许使用者搜索Flickr图片</li>
<li>添加其他提供图片的API</li>
<li>允许用户选择喜欢的API进行搜索.</li>
</ul>
<p>我们仅仅和生成器碰了一下面,但是即便如此,希望在联合使用redux-saga library,Redux和React的时候给你一些帮助.</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Redux/" rel="tag"># Redux</a>
          
            <a href="/tags/saga/" rel="tag"># saga</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/04/翻译-redux-undo-redo-reducer增强组件/" rel="next" title="翻译|redux undo/redo  reducer增强组件">
                <i class="fa fa-chevron-left"></i> 翻译|redux undo/redo  reducer增强组件
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/04/CRA项目的Github-Page部署/" rel="prev" title="CRA项目部署到ghpage的方法">
                CRA项目部署到ghpage的方法 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="React-Apollo">
            
              <p class="site-author-name" itemprop="name">React-Apollo</p>
              <p class="site-description motion-element" itemprop="description">base on javascript</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">136</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">90</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用React-Redux和reudx-saga构建一个图像浏览程序-翻译"><span class="nav-number">1.</span> <span class="nav-text">使用React,Redux和reudx-saga构建一个图像浏览程序(翻译)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#构建一个图片长廊"><span class="nav-number">1.0.1.</span> <span class="nav-text">构建一个图片长廊</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在Gallery中显示一些图片"><span class="nav-number">1.0.2.</span> <span class="nav-text">在Gallery中显示一些图片</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用Redux来管理状态"><span class="nav-number">1.0.3.</span> <span class="nav-text">使用Redux来管理状态</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#启动Redux"><span class="nav-number">1.0.4.</span> <span class="nav-text">启动Redux</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#连接Gallery组件"><span class="nav-number">1.0.5.</span> <span class="nav-text">连接Gallery组件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#默认的应用状态-state"><span class="nav-number">1.1.</span> <span class="nav-text">默认的应用状态(state)</span></a></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#✖-watchForLoadImages-should-call-loadImages-after-LOAD-IMAGES-action-is-received"><span class="nav-number"></span> <span class="nav-text">✖ watchForLoadImages should call loadImages after LOAD_IMAGES action is received</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#✖-watchForLoadImages-should-call-loadImages-after-LOAD-IMAGES-action-is-received-1"><span class="nav-number"></span> <span class="nav-text">✖ watchForLoadImages should call loadImages after LOAD_IMAGES action is received</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#接下来做什么？"><span class="nav-number">0.0.1.</span> <span class="nav-text">接下来做什么？</span></a></li></ol></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">React-Apollo</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">190.2k</span>
  
</div>









        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("0kGBxj215XRijm6VofFkzlws-gzGzoHsz", "V2FDLF52mPXum5Hh6wvwGpEk");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

</body>
</html>
